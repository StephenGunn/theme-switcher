#!/usr/bin/env bash

# Waypaper launcher that opens theme-specific wallpaper folder with theming
# Called via Super+Y keybind

set -euo pipefail

# Paths
PROJECT_DIR="$HOME/projects/theme-switcher"
THEMES_DIR="$PROJECT_DIR/themes"
WAYPAPER_CONFIG="$HOME/.config/waypaper/config.ini"
WAYPAPER_STYLE="$HOME/.config/waypaper/style.css"
CURRENT_THEME_FILE="$HOME/.config/current-theme"

# Get current theme name
if [ ! -f "$CURRENT_THEME_FILE" ]; then
    echo "Error: No current theme set. Run theme-switch first."
    exit 1
fi

CURRENT_THEME=$(cat "$CURRENT_THEME_FILE")
WALLPAPER_FOLDER="$THEMES_DIR/$CURRENT_THEME/wallpapers"

# Verify wallpaper folder exists
if [ ! -d "$WALLPAPER_FOLDER" ]; then
    mkdir -p "$WALLPAPER_FOLDER"
    echo "Created wallpaper folder: $WALLPAPER_FOLDER"
fi

# Source pywal colors for theming
if [ -f "$HOME/.cache/wal/colors.sh" ]; then
    set +u  # Temporarily allow unset variables
    source "$HOME/.cache/wal/colors.sh"
    set -u  # Re-enable unset variable checking
else
    # Fallback colors if wal not available
    color0='#282828'
    color1='#cc241d'
    color2='#98971a'
    color3='#d79921'
    color4='#458588'
    color5='#b16286'
    color6='#689d6a'
    color7='#a89984'
    color8='#928374'
    foreground='#ebdbb2'
    background='#282828'
fi

# Generate waypaper CSS theme
cat > "$WAYPAPER_STYLE" <<EOF
/* Waypaper GTK Theme - Auto-generated by theme-switcher */
/* Theme: $CURRENT_THEME */

/* Main window background */
window {
    background-color: $background;
    color: $foreground;
}

/* Toolbar/header bar */
headerbar {
    background-color: $color0;
    color: $foreground;
    border-bottom: 2px solid $color4;
}

headerbar button {
    background-color: $color8;
    color: $foreground;
    border: 1px solid $color8;
    border-radius: 4px;
    padding: 6px 12px;
}

headerbar button:hover {
    background-color: $color4;
    border-color: $color4;
}

/* Dropdown menus */
combobox button {
    background-color: $color0;
    color: $foreground;
    border: 1px solid $color8;
}

combobox button:hover {
    background-color: $color8;
}

/* Selected wallpaper */
flowboxchild:selected {
    background-color: $color4;
    border: 2px solid $color6;
}

/* Scrollbars */
scrollbar {
    background-color: $color0;
}

scrollbar slider {
    background-color: $color8;
    border-radius: 8px;
}

scrollbar slider:hover {
    background-color: $color4;
}

/* Entry fields */
entry {
    background-color: $color0;
    color: $foreground;
    border: 1px solid $color8;
    border-radius: 4px;
    padding: 6px;
}

/* Labels */
label {
    color: $foreground;
}

/* Buttons */
button {
    background-color: $color0;
    color: $foreground;
    border: 1px solid $color8;
    border-radius: 4px;
    padding: 6px 12px;
}

button:hover {
    background-color: $color4;
    border-color: $color4;
}

/* Checkboxes */
checkbutton {
    color: $foreground;
}

checkbutton check {
    background-color: $color0;
    border: 1px solid $color8;
}

checkbutton check:checked {
    background-color: $color4;
    border-color: $color4;
}
EOF

# Update waypaper config to use theme folder and zen mode
if [ -f "$WAYPAPER_CONFIG" ]; then
    # Backup original config
    cp "$WAYPAPER_CONFIG" "$WAYPAPER_CONFIG.backup"

    # Update folder and zen_mode using sed
    sed -i "s|^folder = .*|folder = $WALLPAPER_FOLDER|" "$WAYPAPER_CONFIG"
    sed -i "s|^zen_mode = .*|zen_mode = True|" "$WAYPAPER_CONFIG"
else
    # Create minimal config if it doesn't exist
    mkdir -p "$(dirname "$WAYPAPER_CONFIG")"
    cat > "$WAYPAPER_CONFIG" <<EOF
[Settings]
language = en
folder = $WALLPAPER_FOLDER
monitors = All
backend = hyprpaper
fill = fill
sort = name
color = #ffffff
subfolders = True
show_hidden = False
zen_mode = True
stylesheet = $WAYPAPER_STYLE
EOF
fi

echo "Opening waypaper with theme: $CURRENT_THEME"
echo "Wallpaper folder: $WALLPAPER_FOLDER"

# Launch waypaper
waypaper --folder "$WALLPAPER_FOLDER"
